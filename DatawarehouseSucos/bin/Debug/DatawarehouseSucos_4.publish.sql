/*
Deployment script for DW_SUCOS

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "DW_SUCOS"
:setvar DefaultFilePrefix "DW_SUCOS"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key afc1558f-c6cc-4e65-8d7f-52e1cf6ccce2 is skipped, element [dbo].[dim_tempo].[Id] (SqlSimpleColumn) will not be renamed to cod_dia';


GO
PRINT N'Rename refactoring operation with key 02d920cd-62ef-41f3-91ef-3401d80380a9 is skipped, element [dbo].[dim_tempo].[e_dia_semana] (SqlSimpleColumn) will not be renamed to tipo_dia';


GO
PRINT N'Rename refactoring operation with key 663ecb1c-c92a-4120-9fc4-df58934c9c21 is skipped, element [dbo].[fato_001].[Id] (SqlSimpleColumn) will not be renamed to cod_cliente';


GO
PRINT N'Rename refactoring operation with key 4ac357b5-92fc-4472-9310-82f9839d01b9 is skipped, element [dbo].[fato_003].[frete] (SqlSimpleColumn) will not be renamed to custo_fixo';


GO
PRINT N'Creating [dbo].[dim_tempo]...';


GO
CREATE TABLE [dbo].[dim_tempo] (
    [cod_dia]            NVARCHAR (50) NOT NULL,
    [data]               DATE          NULL,
    [cod_semana]         INT           NULL,
    [nome_dia_semana]    NVARCHAR (50) NULL,
    [cod_mes]            INT           NULL,
    [nome_mes]           NVARCHAR (50) NULL,
    [cod_mes_ano]        NVARCHAR (50) NULL,
    [nome_mes_ano]       NVARCHAR (50) NULL,
    [cod_trimestre]      INT           NULL,
    [nome_trimestre]     NVARCHAR (50) NULL,
    [cod_trimentre_ano]  NVARCHAR (50) NULL,
    [nome_trimentre_ano] NVARCHAR (50) NULL,
    [cod_semestre]       INT           NULL,
    [nome_semestre]      NVARCHAR (50) NULL,
    [cod_semestre_ano]   NVARCHAR (50) NULL,
    [nome_semestre_ano]  NVARCHAR (50) NULL,
    [ano]                NVARCHAR (50) NULL,
    [tipo_dia]           NVARCHAR (50) NULL,
    PRIMARY KEY CLUSTERED ([cod_dia] ASC)
);


GO
PRINT N'Creating [dbo].[fato_001]...';


GO
CREATE TABLE [dbo].[fato_001] (
    [cod_cliente]        NVARCHAR (50) NOT NULL,
    [cod_produto]        NVARCHAR (50) NOT NULL,
    [cod_organizacional] NVARCHAR (50) NOT NULL,
    [cod_fabrica]        NVARCHAR (50) NOT NULL,
    [cod_dia]            NVARCHAR (50) NOT NULL,
    [faturamento]        FLOAT (53)    NULL,
    [imposto]            FLOAT (53)    NULL,
    [custo_variavel]     FLOAT (53)    NULL,
    [quantidade_vendida] FLOAT (53)    NULL,
    [unidade_vendida]    FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([cod_cliente] ASC, [cod_produto] ASC, [cod_organizacional] ASC, [cod_fabrica] ASC, [cod_dia] ASC)
);


GO
PRINT N'Creating [dbo].[fato_002]...';


GO
CREATE TABLE [dbo].[fato_002] (
    [cod_cliente] NVARCHAR (50) NOT NULL,
    [cod_produto] NVARCHAR (50) NOT NULL,
    [cod_fabrica] NVARCHAR (50) NOT NULL,
    [cod_dia]     NVARCHAR (50) NOT NULL,
    [frete]       FLOAT (53)    NULL,
    CONSTRAINT [PK_fato_002] PRIMARY KEY CLUSTERED ([cod_dia] ASC, [cod_fabrica] ASC, [cod_produto] ASC, [cod_cliente] ASC)
);


GO
PRINT N'Creating [dbo].[fato_003]...';


GO
CREATE TABLE [dbo].[fato_003] (
    [cod_fabrica] NVARCHAR (50) NOT NULL,
    [cod_dia]     NVARCHAR (50) NOT NULL,
    [custo_fixo]  FLOAT (53)    NULL,
    CONSTRAINT [PK_fato_003] PRIMARY KEY CLUSTERED ([cod_dia] ASC, [cod_fabrica] ASC)
);


GO
PRINT N'Creating [dbo].[fato_004]...';


GO
CREATE TABLE [dbo].[fato_004] (
    [cod_cliente]        NVARCHAR (50) NOT NULL,
    [cod_produto]        NVARCHAR (50) NOT NULL,
    [cod_organizacional] NVARCHAR (50) NOT NULL,
    [cod_dia]            NVARCHAR (50) NOT NULL,
    [meta_faturamento]   FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([cod_cliente] ASC, [cod_produto] ASC, [cod_organizacional] ASC, [cod_dia] ASC)
);


GO
PRINT N'Creating [dbo].[fato_005]...';


GO
CREATE TABLE [dbo].[fato_005] (
    [cod_produto] NVARCHAR (50) NOT NULL,
    [cod_fabrica] NVARCHAR (50) NOT NULL,
    [cod_dia]     NVARCHAR (50) NOT NULL,
    [meta_custo]  FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([cod_produto] ASC, [cod_fabrica] ASC, [cod_dia] ASC)
);


GO
PRINT N'Creating [dbo].[FK_fato_001_dim_cliente]...';


GO
ALTER TABLE [dbo].[fato_001] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_001_dim_cliente] FOREIGN KEY ([cod_cliente]) REFERENCES [dbo].[dim_cliente] ([cod_cliente]);


GO
PRINT N'Creating [dbo].[FK_fato_001_dim_produto]...';


GO
ALTER TABLE [dbo].[fato_001] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_001_dim_produto] FOREIGN KEY ([cod_produto]) REFERENCES [dbo].[dim_produto] ([cod_produto]);


GO
PRINT N'Creating [dbo].[FK_fato_001_dim_organizacional]...';


GO
ALTER TABLE [dbo].[fato_001] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_001_dim_organizacional] FOREIGN KEY ([cod_organizacional]) REFERENCES [dbo].[dim_organizacional] ([cod_filho]);


GO
PRINT N'Creating [dbo].[FK_fato_001_dim_fabrica]...';


GO
ALTER TABLE [dbo].[fato_001] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_001_dim_fabrica] FOREIGN KEY ([cod_fabrica]) REFERENCES [dbo].[dim_fabrica] ([cod_fabrica]);


GO
PRINT N'Creating [dbo].[FK_fato_001_dim_dia]...';


GO
ALTER TABLE [dbo].[fato_001] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_001_dim_dia] FOREIGN KEY ([cod_dia]) REFERENCES [dbo].[dim_tempo] ([cod_dia]);


GO
PRINT N'Creating [dbo].[FK_fato_002_dim_cliente]...';


GO
ALTER TABLE [dbo].[fato_002] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_002_dim_cliente] FOREIGN KEY ([cod_cliente]) REFERENCES [dbo].[dim_cliente] ([cod_cliente]);


GO
PRINT N'Creating [dbo].[FK_fato_002_dim_produto]...';


GO
ALTER TABLE [dbo].[fato_002] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_002_dim_produto] FOREIGN KEY ([cod_produto]) REFERENCES [dbo].[dim_produto] ([cod_produto]);


GO
PRINT N'Creating [dbo].[FK_fato_002_dim_fabrica]...';


GO
ALTER TABLE [dbo].[fato_002] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_002_dim_fabrica] FOREIGN KEY ([cod_fabrica]) REFERENCES [dbo].[dim_fabrica] ([cod_fabrica]);


GO
PRINT N'Creating [dbo].[FK_fato_002_dim_dia]...';


GO
ALTER TABLE [dbo].[fato_002] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_002_dim_dia] FOREIGN KEY ([cod_dia]) REFERENCES [dbo].[dim_tempo] ([cod_dia]);


GO
PRINT N'Creating [dbo].[FK_fato_003_dim_fabrica]...';


GO
ALTER TABLE [dbo].[fato_003] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_003_dim_fabrica] FOREIGN KEY ([cod_fabrica]) REFERENCES [dbo].[dim_fabrica] ([cod_fabrica]);


GO
PRINT N'Creating [dbo].[FK_fato_003_dim_dia]...';


GO
ALTER TABLE [dbo].[fato_003] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_003_dim_dia] FOREIGN KEY ([cod_dia]) REFERENCES [dbo].[dim_tempo] ([cod_dia]);


GO
PRINT N'Creating [dbo].[FK_fato_004_dim_cliente]...';


GO
ALTER TABLE [dbo].[fato_004] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_004_dim_cliente] FOREIGN KEY ([cod_cliente]) REFERENCES [dbo].[dim_cliente] ([cod_cliente]);


GO
PRINT N'Creating [dbo].[FK_fato_004_dim_produto]...';


GO
ALTER TABLE [dbo].[fato_004] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_004_dim_produto] FOREIGN KEY ([cod_produto]) REFERENCES [dbo].[dim_produto] ([cod_produto]);


GO
PRINT N'Creating [dbo].[FK_fato_004_dim_organizacional]...';


GO
ALTER TABLE [dbo].[fato_004] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_004_dim_organizacional] FOREIGN KEY ([cod_organizacional]) REFERENCES [dbo].[dim_organizacional] ([cod_filho]);


GO
PRINT N'Creating [dbo].[FK_fato_004_dim_dia]...';


GO
ALTER TABLE [dbo].[fato_004] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_004_dim_dia] FOREIGN KEY ([cod_dia]) REFERENCES [dbo].[dim_tempo] ([cod_dia]);


GO
PRINT N'Creating [dbo].[FK_fato_005_dim_produto]...';


GO
ALTER TABLE [dbo].[fato_005] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_005_dim_produto] FOREIGN KEY ([cod_produto]) REFERENCES [dbo].[dim_produto] ([cod_produto]);


GO
PRINT N'Creating [dbo].[FK_fato_005_dim_fabrica]...';


GO
ALTER TABLE [dbo].[fato_005] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_005_dim_fabrica] FOREIGN KEY ([cod_fabrica]) REFERENCES [dbo].[dim_fabrica] ([cod_fabrica]);


GO
PRINT N'Creating [dbo].[FK_fato_005_dim_dia]...';


GO
ALTER TABLE [dbo].[fato_005] WITH NOCHECK
    ADD CONSTRAINT [FK_fato_005_dim_dia] FOREIGN KEY ([cod_dia]) REFERENCES [dbo].[dim_tempo] ([cod_dia]);


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'afc1558f-c6cc-4e65-8d7f-52e1cf6ccce2')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('afc1558f-c6cc-4e65-8d7f-52e1cf6ccce2')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '02d920cd-62ef-41f3-91ef-3401d80380a9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('02d920cd-62ef-41f3-91ef-3401d80380a9')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '663ecb1c-c92a-4120-9fc4-df58934c9c21')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('663ecb1c-c92a-4120-9fc4-df58934c9c21')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '4ac357b5-92fc-4472-9310-82f9839d01b9')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('4ac357b5-92fc-4472-9310-82f9839d01b9')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[fato_001] WITH CHECK CHECK CONSTRAINT [FK_fato_001_dim_cliente];

ALTER TABLE [dbo].[fato_001] WITH CHECK CHECK CONSTRAINT [FK_fato_001_dim_produto];

ALTER TABLE [dbo].[fato_001] WITH CHECK CHECK CONSTRAINT [FK_fato_001_dim_organizacional];

ALTER TABLE [dbo].[fato_001] WITH CHECK CHECK CONSTRAINT [FK_fato_001_dim_fabrica];

ALTER TABLE [dbo].[fato_001] WITH CHECK CHECK CONSTRAINT [FK_fato_001_dim_dia];

ALTER TABLE [dbo].[fato_002] WITH CHECK CHECK CONSTRAINT [FK_fato_002_dim_cliente];

ALTER TABLE [dbo].[fato_002] WITH CHECK CHECK CONSTRAINT [FK_fato_002_dim_produto];

ALTER TABLE [dbo].[fato_002] WITH CHECK CHECK CONSTRAINT [FK_fato_002_dim_fabrica];

ALTER TABLE [dbo].[fato_002] WITH CHECK CHECK CONSTRAINT [FK_fato_002_dim_dia];

ALTER TABLE [dbo].[fato_003] WITH CHECK CHECK CONSTRAINT [FK_fato_003_dim_fabrica];

ALTER TABLE [dbo].[fato_003] WITH CHECK CHECK CONSTRAINT [FK_fato_003_dim_dia];

ALTER TABLE [dbo].[fato_004] WITH CHECK CHECK CONSTRAINT [FK_fato_004_dim_cliente];

ALTER TABLE [dbo].[fato_004] WITH CHECK CHECK CONSTRAINT [FK_fato_004_dim_produto];

ALTER TABLE [dbo].[fato_004] WITH CHECK CHECK CONSTRAINT [FK_fato_004_dim_organizacional];

ALTER TABLE [dbo].[fato_004] WITH CHECK CHECK CONSTRAINT [FK_fato_004_dim_dia];

ALTER TABLE [dbo].[fato_005] WITH CHECK CHECK CONSTRAINT [FK_fato_005_dim_produto];

ALTER TABLE [dbo].[fato_005] WITH CHECK CHECK CONSTRAINT [FK_fato_005_dim_fabrica];

ALTER TABLE [dbo].[fato_005] WITH CHECK CHECK CONSTRAINT [FK_fato_005_dim_dia];


GO
PRINT N'Update complete.';


GO
